# 完全独立便携版 - 使用说明

## 制作便携版

### 步骤

1. **构建 EXE**
   ```bash
   pnpm win:build-exe
   ```

2. **运行制作脚本**
   
   双击运行：`制作便携版.bat`
   
   脚本会自动：
   - 首次运行 EXE 并强制便携模式
   - 复制所有项目文件到 AppData
   - 安装依赖
   - 提示是否复制到桌面

3. **完成！**
   
   现在 `Chaoxing.exe` 可以放到任何位置运行

## 工作原理

### 便携模式目录结构

```
%LOCALAPPDATA%\ChaoxingSignin\
├── app\                    (工作目录)
│   ├── apps\              (应用代码)
│   ├── packages\          (依赖包)
│   ├── node_modules\      (已安装的依赖)
│   ├── package.json
│   ├── pnpm-lock.yaml
│   └── ...
└── logs\                  (日志目录)
    └── launcher-*.log
```

### 便携模式特点

✅ **完全独立**
- EXE 可以放在任何位置
- 可以复制到 U 盘
- 可以创建桌面快捷方式

✅ **自动识别**
- 从任何目录启动都能工作
- 自动使用 AppData 工作目录

✅ **数据集中**
- 所有数据都在 AppData
- 日志、配置统一管理

## 使用方法

### 方式1：桌面运行

1. 把 `Chaoxing.exe` 复制到桌面
2. 右键 → "以管理员身份运行"
3. 浏览器自动打开 http://localhost:3000

### 方式2：创建快捷方式

1. 右键 `Chaoxing.exe` → "发送到" → "桌面快捷方式"
2. 右键快捷方式 → 属性 → 高级
3. 勾选"用管理员身份运行"
4. 确定

### 方式3：直接运行

双击 `Chaoxing.exe` 即可（会显示权限警告）

## 命令行参数

```bash
# 普通启动
Chaoxing.exe

# 跳过管理员权限检查
Chaoxing.exe --no-elevate

# 调试模式
Chaoxing.exe --debug

# 强制便携模式（制作时使用）
Chaoxing.exe --portable

# 组合使用
Chaoxing.exe --no-elevate --debug
```

## 访问地址

程序启动后：

- **前端界面**：http://localhost:3000
- **后端 API**：http://localhost:5000

## 日志位置

```
%LOCALAPPDATA%\ChaoxingSignin\logs\
```

通常是：
```
C:\Users\你的用户名\AppData\Local\ChaoxingSignin\logs\
```

## 更新便携版

如果项目代码更新了：

1. 重新构建：`pnpm win:build-exe`
2. 重新运行：`制作便携版.bat`
3. 选择"删除并重新初始化"
4. 完成

## 卸载

删除以下目录：

1. `%LOCALAPPDATA%\ChaoxingSignin\`（所有数据）
2. 桌面上的 EXE 文件（如果有）
3. 开始菜单快捷方式（如果有）

## 常见问题

### Q: 可以在 U 盘上运行吗？

A: 可以！但首次需要在电脑上初始化（运行 `制作便携版.bat`），
   之后把 EXE 和 AppData 目录一起复制到 U 盘即可。

### Q: 依赖安装在哪里？

A: 在 `%LOCALAPPDATA%\ChaoxingSignin\app\node_modules\`

### Q: 为什么需要管理员权限？

A: 安装依赖、配置系统任务等需要管理员权限。
   如果只是运行已初始化的程序，可以用 `--no-elevate` 跳过。

### Q: 程序启动失败怎么办？

A: 
1. 检查日志：`%LOCALAPPDATA%\ChaoxingSignin\logs\`
2. 确保已运行过 `制作便携版.bat` 初始化
3. 尝试以管理员身份运行
4. 检查是否有 Node.js 安装

### Q: 可以同时使用项目模式和便携模式吗？

A: 可以！
- 从 `dist/` 目录运行：自动使用项目模式
- 从其他位置运行：自动使用便携模式

## 技术细节

### 运行模式检测

程序启动时会自动检测：

1. 是否打包成 EXE（`process.pkg`）
2. EXE 所在目录是否有项目文件（`package.json`）
3. 是否使用 `--portable` 参数

**决策逻辑：**

```
如果打包成 EXE：
  如果使用 --portable 参数：
    → 便携模式
  否则如果找到项目文件：
    → 项目模式
  否则：
    → 便携模式
否则（开发模式）：
  → 使用当前目录
```

### 便携模式初始化

首次便携模式运行时：

1. 创建 AppData 目录
2. 检测项目源文件位置
3. 复制必要文件：
   - `package.json`
   - `pnpm-lock.yaml`
   - `pnpm-workspace.yaml`
   - `turbo.json`
   - `apps/` 目录
   - `packages/` 目录
4. 安装依赖（自动）

## 最佳实践

✅ **推荐做法：**
1. 使用 `制作便携版.bat` 初始化
2. 创建桌面快捷方式
3. 设置"以管理员身份运行"
4. 定期查看日志

❌ **不推荐：**
1. 手动复制文件到 AppData
2. 不以管理员身份运行（可能功能受限）
3. 同时运行多个实例

## 支持

如遇问题，请查看：

1. 日志文件：`%LOCALAPPDATA%\ChaoxingSignin\logs\`
2. 项目 Issues：https://github.com/cxOrz/chaoxing-signin/issues
